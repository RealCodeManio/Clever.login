<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/index.css">
  <link rel="shortcut icon" href="../images/logo.png" type="image/png">
  <title>Loading... | 3kh0</title>

  <style>
    html,
    body {
      margin: 0px;
      width: 100%;
      height: 100%;
      overflow: hidden;
      text-align: center;
      user-select: none;
    }

    iframe {
      width: 100%;
      height: 100%;
    }

    .spinner {
      margin: 0px;
    }

    .playgame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 500px;
      height: 500px;
    }

    .hidden {
      display: none;
    }

    .loader {
      margin: 20px;
    }

    .loader.center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .overlay {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 99999999999;
      top: 0;
      left: 0;
      background: var(--background);
    }

    .game_img {
      border-radius: 10%;
      width: 200px;
      height: 200px;
    }

    .spinner {
      height: 150px;
      width: 150px;
      margin: 50px;
    }
  </style>
</head>

<body theme="default">
  <center class="playgame">
    <div class="loader">
      <span class="spinner">
        <svg viewBox="22 22 44 44">
          <circle class="spinnerSvg" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle>
        </svg>
      </span>
    </div>
    <h1 id="game">Loading...</h1>
    <button class="play hidden" id="startgame" data-aos="fade-up">Play</button>
  </center>

  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const gameSubpath = urlParams.get('game');
    const path = location.pathname;
    const origin = localStorage.getItem('instance');

    async function isBlocked(url) {
      try {
        var README = await fetch(url + '/README.md');
        var content = await README.text();
        if (content.startsWith('# 3kh0 Assets')) {
          return false;
        } else {
          return true;
        }
      } catch {
        return true;
      }
    }

    async function getCDN(cdns) {
      for (let cdn in cdns) {
        var blocked = await isBlocked(cdns[cdn]);
        if (!blocked) {
          return cdns[cdn];
        }
      }

      return cdns[0];
    }

    if (!origin) {
      window.location.href = `../?onload=window.location.href='${path}${queryString}'`;
    }

    const instance = origin.replace(location.origin, '');

    if (game && origin) {
      fetch('./JSON/cdns.json')
        .then(res => res.json())
        .then(async cdns => {
          const cdn = await getCDN(cdns);

          fetch('./JSON/games.json')
            .then(res => res.json())
            .then(games => {
              const gameRoots = [];

              for (let i = 0; i < games.length; i++) {
                gameRoots.push(games[i].root);
              }
              
              const game = games[gameRoots.indexOf(gameSubpath)];
              document.title = `Play ${game.name} | 3kh0`;
              window.history.pushState({}, '', `${origin}games/${gameSubpath}`);
              document.querySelector('#game').textContent = game.name;
              document.querySelector('.loader').innerHTML = `<img src="${cdn + '/' + game.root + '/' + game.img}" class="game_img" onerror="this.src='../assets/globe.svg'"/>`;
              document.querySelector('#startgame').classList.remove('hidden');

              document.querySelector('#startgame').addEventListener('click', (e) => {
                document.body.innerHTML = `
                <iframe frameborder="0" src="${cdn + '/' + game.root + '/' + game.file}" onerror="document.write('Could not load game');" onload="document.querySelector('.overlay').remove();"></iframe>
                <div class="overlay">
                  <div class="loader center">
                    <span class="spinner">
                      <svg viewBox="22 22 44 44">
                        <circle class="spinnerSvg" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle>
                      </svg>
                    </span>
                  </div>
                </div>
                `;
              })
            });
        })

      const compiledGames = [];
      fetch('../assets/JSON/games.json')
        .then(res => res.json())
        .then(games => {

          games.forEach(game => {
            if (game.name && game.url && game.img) {
              const root = game.url.replace('./files/', '').replace('/index.html', '');

              compiledGames.push({
                name: game.name,
                root: root,
                file: game.url.replace('./files/' + root, '').slice(1),
                img: game.img.replace('./files/' + root, '').slice(1)
              })
            }
          })
        }).catch(e => { alert(e) })

      /*navigator.serviceWorker.getRegistrations()
        .then((registrations) => {
          if (!registrations[0]) {
            try {
              navigator.serviceWorker.register(`${origin}gamesw.js?instancepath=${instance}`);
            } catch (e) {
              throw new Error(`Service Worker registration failed: ${e}`);
            }
          }
        }).catch(e => {
          throw new Error(`Service Worker registration failed: ${e}`);
        })*/
    } else {
      document.documentElement.innerText = 'Could not load game';
    }

    if (window.top === window.self) {
      //window.location.href = origin;
    }
  </script>
</body>

</html>